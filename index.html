<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JsSIP Caller</title>
    <script src="./lib/jquery-3.7.1.js"></script>
    <script src="./lib/jssip.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }

        #callControl {
            max-width: 400px;
            margin: 0 auto;
        }

        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .input-group label {
            width: 120px;
            text-align: right;
            margin-right: 10px;
        }

        input {
            flex-grow: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        #loginBtn { background-color: #007bff; width: 100%; }
        #loginBtn:disabled { background-color: #003d88; width: 100%; }
        #logoutBtn { background-color: #dc3545; width: 100%; }
        #callBtn { background-color: #28a745; width: 100%; }
        #callBtn:disabled { background-color: #145a23; width: 100%; }
        #hangupBtn { background-color: #dc3545; width: 100%; }
        #acceptBtn { background-color: #28a745; width: 100%; }

        #state {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div id="callControl">
    <h2>JsSIP Caller</h2>
    <div id="login">
        <div class="input-group">
            <label for="username">SIP Username:</label>
            <input type="text" id="username" value="ptt1">
        </div>
        <div class="input-group">
            <label for="password">SIP Password:</label>
            <input type="password" id="password">
        </div>
        <div class="input-group">
            <label for="uri">URI domain:</label>
            <input type="text" id="uri" value="pbx-sip.admin.zifi.ca">
        </div>
        <div class="input-group">
            <label for="server">Server:</label>
            <input type="text" id="server" value="pbx-sip.admin.zifi.ca:8089/ws">
        </div>
        <div class="button-group">
            <button id="loginBtn">Login</button>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>
    <div id="dialer">
        <div class="input-group">
            <label for="num">Number to call:</label>
            <input id="num" type="text" value="1003">
        </div>
        <div class="button-group">
            <button id="callBtn" style="display: none" disabled>Call</button>
            <button id="hangupBtn" style="display: none">Hangup</button>
            <button id="acceptBtn" style="display: none">Accept</button>
        </div>
    </div>
    <div id="state">Not connected</div>
</div>

<script>
JsSIP.debug.enable('JsSIP:*');

const remoteAudio = new window.Audio();
remoteAudio.autoplay = true;

let ua, session;

  const state = (conn, regi, call, message, incoming) => {
    $('#state').text( ( incoming ? 'Incoming ' : '' ) + message );
    console.log(message);

    $('#loginBtn').prop('disabled', regi === 'registered')

    if (['ended', 'failed', 'available'].includes(call)) {
      $('#callBtn').show().prop('disabled', regi !== 'registered');
    } else {
      $('#callBtn').hide();
    }

    if (incoming && call === 'progress') {
      $('#acceptBtn').show();
    } else {
      $('#acceptBtn').hide();
    }

    if (['accepted', 'progress', 'confirmed'].includes(call)) {
      $('#hangupBtn').show();
    } else {
      $('#hangupBtn').hide();
    }
};

const setupUA = () => {
    const config = {
        sockets: [new JsSIP.WebSocketInterface('wss://' + $('#server').val(), {
            requestParams: { tlsOptions: { rejectUnauthorized: false } }
        })],
        uri: 'sip:' + $('#username').val() + '@' + $('#uri').val(),
        password: $('#password').val()
    };

    ua = new JsSIP.UA(config);

    ua.on('connecting', () => {
      state( 'connecting', 'unregistered', 'unavailable', 'Connecting');
    });
    ua.on('connected', () => {
      state( 'connected',  'unregistered', 'unavailable', 'Connected');
      ua.register();
    });
    ua.on('disconnected', () => {
      state( 'disconnected',  'unregistered', 'unavailable', 'Disconnected');
    });
    ua.on('registered', () => {
      state( 'connected',  'registered', 'available', 'Registered');
    });
    ua.on('unregistered', () => {
      state( 'connected',  'unregistered', 'unavailable', 'Unregistered');
    });
    ua.on('registrationFailed', () => {
      state( 'connected',  'unregistered', 'unavailable', 'Registration Failed');
    });

    ua.on('newRTCSession', ({ session: newSession }) => {
        session = newSession;

        let incoming = newSession.direction === 'incoming';
        session.on('progress', () => {
	  state( 'connected',  'registered', 'progress', 'Call in progress', incoming );
        });
        session.on('ended', () => {
	  state( 'connected',  'registered', 'ended', 'Call ended', incoming );
        });
        session.on('failed', () => {
	  state( 'connected',  'registered', 'failed', 'Call failed', incoming );
        });
        session.on('accepted', () => {
	  state( 'connected',  'registered', 'accepted', 'Call accepted', incoming );
        });
        session.on('confirmed', () => {
	  state( 'connected',  'registered', 'confirmed', 'Call confirmed', incoming );
        });
        session.on('trackAdded', (e) => {
	  state( 'connected',  'registered', 'confirmed', 'Stream connected', incoming );
          remoteAudio.srcObject = e.streams[0];
        });
    });
};

$('#loginBtn').click(() => {
    setupUA();
    ua.start();
    remoteAudio.muted = false;
});

$('#logoutBtn').click(() => {
    if (ua) {
        ua.stop();
    }
    remoteAudio.muted = true;
});

$('#callBtn').click(() => {
    session = ua.call($('#num').val(), {
        mediaConstraints: { audio: true, video: false }
    });
});

$('#hangupBtn').click(() => {
    session.terminate();
});

$('#acceptBtn').click(() => {
    session.answer();
});
</script>
</body>
</html>
