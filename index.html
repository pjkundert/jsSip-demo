<!DOCTYPE HTML>
<html>
<head>
    <script type="text/javascript" src="./lib/jquery-3.7.1.js"></script>
    <script type="text/javascript" src="./lib/jsSIP/jssip-3.10.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./styles.css">
</head>
<body>
<div id="callControl">
    <h2>JsSIP Caller</h2>
    <div id="to">
        <input id="num" type="text" value="1003"/>
    </div>
    <div id="login">
        <label for="username">SIP Username:</label>
        <input type="text" id="username" value="ptt1">
	<br>
        <label for="password">SIP Password:</label>
        <input type="password" id="password" placeholder="">
	<br>
        <label for="uri">sip:user@... URI domain:</label>
        <input type="text" id="uri" value="pbx-sip.admin.zifi.ca">
	<br>
        <label for="server">wss://... Server:</label>
        <input type="text" id="server" value="pbx-sip.admin.zifi.ca:8089/ws">
	<br>
        <button id="loginBtn">Login</button>
        <button id="logoutBtn">Logout</button>
	<div id="state"/> 
    </div>
    <button id="call" style="display: flex" disabled>Call</div>
    <button id="hangup" style="display: none">Hangup</div>
    <button id="accept" style="display: none">Accept</div>
    <button id="decline" style="display: none">Decline</div>
</div>

<script>
    JsSIP.debug.enable('JsSIP:*');

    var remoteAudio = new window.Audio();
    remoteAudio.autoplay = true;
    var socket;
    var ua;
    var session;


    $('#logoutBtn').click(function () {
	if ( ua ) {
	    ua.stop();
	}
    })

    // Функция для аутентификации пользователя
    $('#loginBtn').click(function () {
        var username = $('#username').val();
        var password = $('#password').val();
        var server = $('#server').val();
        var uri = $('#uri').val();
 
	if ( socket ) {
	    // Attempt to cleanly shut down the connection for a moment
	    ua.stop();
	}

        socket = new JsSIP.WebSocketInterface('wss://' + server, {
            requestParams: {
                tlsOptions: {
                    rejectUnauthorized: false
                }
            }
        });

        var configuration = {
            sockets: [socket],
            uri: 'sip:' + username + '@' + uri,
            password: password
        };

        ua = new JsSIP.UA(configuration);

        // События регистрации клиента
        ua.on('connected', function (e) {
	    $('#state').html("Connected")
            console.log('connected');
            ua.register();
            $('#call').css({'display': 'flex'}).prop('disabled', true);
        });

        ua.on('registered', function (e) {
	    $('#state').html("Registered")
            console.log('registered');
            $('#call').css({'display': 'flex'}).prop('disabled', false);
        });

        ua.on('unregistered', function (e) {
	    $('#state').html("Unregistered")
            console.log('unregistered');
            $('#call').css({'display': 'flex'}).prop('disabled', true);
            $('#hangup').css({'display': 'none'});
            $('#accept').css({'display': 'none'});
            $('#decline').css({'display': 'none'});
        });

        ua.on('registrationFailed', function (e) {
	    $('#state').html("Registration Failed")
            console.log('registrationFailed');
            $('#call').css({'display': 'flex'}).prop('disabled', true);
            $('#hangup').css({'display': 'none'});
            $('#accept').css({'display': 'none'});
            $('#decline').css({'display': 'none'});
        });

        // Обработка входящих вызовов
        ua.on('newRTCSession', function (data) {
            var newSession = data.session;
	    $('#state').html(`New RTC Session ${data.session.direction}`)
	    console.log('newRTCSession', data)
            if (newSession.direction === 'incoming') {
                // Обработка входящего вызова
                $('#call').css({'display': 'none'});
                $('#hangup').css({'display': 'none'});
                $('#accept').css({'display': 'flex'});
                $('#decline').css({'display': 'flex'});

                $('#accept').click(function () {
                    newSession.answer();
                    $('#accept').css({'display': 'none'});
                    $('#decline').css({'display': 'none'});
                    $('#hangup').css({'display': 'flex'});
                });

                $('#decline').click(function () {
                    newSession.terminate();
                    $('#accept').css({'display': 'none'});
                    $('#decline').css({'display': 'none'});
                    $('#call').css({'display': 'flex'});
                });

                newSession.on('ended', function () {
                    $('#accept').css({'display': 'none'});
                    $('#decline').css({'display': 'none'});
                    $('#call').css({'display': 'flex'});
                    $('#hangup').css({'display': 'none'});
                });
            }
        });

	// All callbacks registered; start
        ua.start();
    });

    // Обработка события исх. звонка и кнопки для звонка
    var eventHandlers = {
        'progress': function (e) {
	    $('#state').html("Call in progress")
            console.log('call is in progress');
            $('#call').css({'display': 'none'})
            $('#hangup').css({'display': 'flex'});
            $('#accept').css({'display': 'none'});
            $('#decline').css({'display': 'none'});
        },
        'failed': function (e) {
	    $('#state').html(`Call failed: ${e.cause}`)
            console.log('call failed with cause: ' + e.cause);
            $('#call').css({'display': 'flex'}).prop('disabled', false);
            $('#hangup').css({'display': 'none'});
            $('#accept').css({'display': 'none'});
            $('#decline').css({'display': 'none'});
        },
        'ended': function (e) {
	    $('#state').html(`Call ended: ${e.cause}`)
            console.log('call ended with cause: ' + e.cause);
            $('#call').css({'display': 'flex'}).prop('disabled', false);
            $('#hangup').css({'display': 'none'});
            $('#accept').css({'display': 'none'});
            $('#decline').css({'display': 'none'});
        },
        'confirmed': function (e) {
	    $('#state').html("Call Confirmed")
            console.log('call confirmed');
            $('#call').css({'display': 'none'});
            $('#hangup').css({'display': 'flex'})
        },
        'trackAdded': function (e) {
	    $('#state').html("Track Added")
            console.log('trackAdded');
            remoteAudio.srcObject = e.streams[0];
        }
    };

    var options = {
        'eventHandlers': eventHandlers,
        'mediaConstraints': {'audio': true, 'video': false}
    };

    // Кнопка для звонка
    $('#call').click(function (e) {
        session = ua.call($('#num').val(), options);
        $('#call').css({'display': 'flex'}).prop('disabled', true);
    });

    // Кнопка для отбоя звонка
    $('#hangup').click(function () {
        if (session) {
            session.terminate();
        }
    });
</script>
</body>
</html>
